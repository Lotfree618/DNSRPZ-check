# 域名台湾DNS RPZ检测（执行方案）

> 目标：做一个简洁、可部署到单台 VPS 的单页网页工具（Vue SPA + Python FastAPI）。后端维护一个 `Domains.txt`（每行一个域名），后台任务每 **10 秒**对域名列表做一次 DNS RPZ 可用性探测：对比 **基准解析器（8.8.8.8 / 1.1.1.1）** 与 **台湾解析器（168.95.1.1 / 101.101.101.101）** 的 A/AAAA 解析结果，判断域名在台湾 DNS 视角下是否 **正常**或 **异常（污染/封锁/检测失败）**。前端每 **10 秒**自动刷新并实时渲染结果；列表仅展示“正常/异常”，点击域名后展示细节（从面到点）。全站文案与结果输出均为简体中文；浏览器标签页标题与页面标题统一为：**域名台湾DNS RPZ检测**。

---

## 1. 范围与原则

### 1.1 功能范围（MVP）
1. **域名列表来源**：服务端 `Domains.txt`（每行一个域名），后端定时读取并探测。
2. **自动探测**：每 10 秒进行一次全量探测（可并发、可限速）。
3. **前端自动刷新**：每 10 秒拉取最新结果并更新 UI（无需手动输入与点击查询）。
4. **域名可用性展示（从面到点）**：
   - 列表视图：只显示域名 + 状态徽标（**正常** / **异常**）+ 最近检测时间。
   - 详情视图：点击域名后展开/进入详情，展示每个解析器的明确分类与 IP 列表、以及最终“异常原因（确定性词汇）”。
5. **IP 展示完整可读**：所有 IP 必须完整展示；对多 IP（例如 `google.com`、`8.8.8.8` 这类会解析出多条）提供 **折叠/展开**，默认折叠到前 N 条，展开后显示全部。
6. **单机部署**：前端静态文件 + 后端 API 同机部署（Nginx + systemd + HTTPS）。

### 1.2 结果口径（确定性词汇）
为避免“疑似/可能”这种不确定措辞，本工具统一采用以下确定性分类：

- **域名级状态**（列表展示用，仅两种）：
  - **正常**
  - **异常**（包含“污染/封锁”与“检测失败”两大类）

- **解析器级分类**（详情展示用）：
  - **正常**：返回 IP 集合是基准集合的子集（或等价）且不命中黑名单
  - **解析差异**：返回 IP 集合与基准集合不满足子集关系，且不命中黑名单（仅作为“差异记录”，不直接判定污染）
  - **被阻断**：在基准可解析的前提下，台湾解析器返回 NXDOMAIN
  - **已封锁**：台湾解析器返回 IP 命中黑名单 IP
  - **超时**：查询超时
  - **错误**：非超时类错误（解析异常、网络异常等）

- **异常原因（域名级）**：从以下集合中选择（可多条）：
  - **污染：被阻断**
  - **污染：已封锁**
  - **检测失败：超时**
  - **检测失败：错误**
  - **基准无结果**（基准解析器都没有得到任何 A/AAAA 记录）

> 说明：为了满足“列表只展示正常/异常”的要求，任何“超时/错误/基准无结果”都归入 **异常**（但在详情中会精确标注其属于“检测失败”还是“污染/封锁”）。

---

## 2. 总体架构

```
[Vue SPA (同VPS静态文件)]  --HTTPS-->  [Nginx]
                                     |-> /           (静态前端)
                                     `-> /api/*  --> [FastAPI + Uvicorn (127.0.0.1:8000)]
                                                      |
                                                      `--(UDP/TCP 53)--> 8.8.8.8 / 1.1.1.1 / 168.95.1.1 / 101.101.101.101
```

- 后端在启动时拉起一个后台任务：每 10 秒读取 `Domains.txt` 并并发探测，结果写入内存缓存（可选落盘）。
- 前端使用定时轮询（`setInterval`）每 10 秒调用后端 API 拉取“域名摘要列表”；点击域名时再拉取该域名详情或使用同一 API 的 detail 字段。

---

## 3. 域名列表（Domains.txt）规范

### 3.1 文件位置与格式
- 文件名：`Domains.txt`
- 建议路径：`/opt/dnsrpz/Domains.txt`（与后端同目录或由配置项指定）
- 格式：
  - 一行一个域名（可包含 IDN，如 `例子.测试`）
  - 允许空行与注释行（以 `#` 开头）
  - 自动 `strip()` 去除首尾空白
  - 自动转小写并去除尾部 `.`

示例：
```txt
# 一行一个域名
google.com
example.com
youtube.com
```

### 3.2 读取策略
- 每轮探测开始前读取并解析 `Domains.txt`，实现“热更新”：你修改文件后，最迟 10 秒内生效。
- 对重复域名做去重（保留一份）。
- 对无效域名（空、含空格、长度超限）记录为“错误”，并在详情中给出原因。

---

## 4. 后端（Python FastAPI）详细方案

### 4.1 技术栈
- Web 框架：FastAPI
- 运行：Uvicorn
- DNS：dnspython
- 并发：asyncio（后台任务并发探测、API 读缓存）

### 4.2 依赖清单（requirements.txt）
```txt
fastapi
uvicorn[standard]
dnspython
pydantic
```

### 4.3 工程结构（建议）
```
backend/
  app/
    main.py            # FastAPI 入口 + 后台调度
    config.py          # resolver 列表、超时、探测间隔、Domains.txt 路径、黑名单等
    schemas.py         # Pydantic 模型
    domains.py         # Domains.txt 读取与规范化
    dns_probe.py       # A/AAAA 查询与结果归一化
    verdict.py         # 分类与域名级聚合逻辑
    store.py           # 内存缓存（可选落盘）
  requirements.txt
```

### 4.4 后台调度（每 10 秒探测）
- FastAPI 启动时创建一个 `asyncio.create_task(probe_loop())`：
  - `while True`：读取域名列表 → 并发探测 → 写入缓存 → `await asyncio.sleep(10)`
- 探测并发建议：
  - 用 `asyncio.Semaphore(max_concurrency)` 控制每轮最多并发域名数（例如 50）
  - 每个域名内部并发查询 4 个 resolver（2 基准 + 2 台湾）

### 4.5 DNS 查询策略（实现细节）
- 记录类型：A + AAAA（均查询）
- 单次超时：基准 3s、台湾 4s（可配置）
- UDP 优先；必要时 TCP fallback（dnspython 支持）
- 返回统一结构：
  - `status`：`ok` / `nxdomain` / `timeout` / `error`
  - `ips`：字符串数组（成功时）
  - `msg`：错误信息（仅 error 时）

### 4.6 RPZ/污染判定（确定性规则）

#### 4.6.1 解析器列表
- 基准：
  - Google DNS：8.8.8.8
  - Cloudflare DNS：1.1.1.1
- 台湾：
  - 中华电信：168.95.1.1
  - Twnic：101.101.101.101

#### 4.6.2 黑名单 IP（BLOCK_PAGE_IPS）
若台湾解析器返回的任一 IP 命中黑名单，则判定该解析器为 **已封锁**，并使域名级状态进入 **异常**（污染：已封锁）。示例黑名单（可扩展/可配置）：
- 182.173.0.181
- 127.0.0.1
- 0.0.0.0
- （建议）支持 CIDR：例如某些拦截页可能落在特定网段（可选增强）

#### 4.6.3 基准集合构建
- 分别查询 8.8.8.8 与 1.1.1.1 的 A/AAAA
- 将两者返回 IP 合并为集合：`baseline_ips`
- 若 `baseline_ips` 为空：域名级直接判定 **异常（基准无结果）**，详情仍保留每个解析器结果用于排查

#### 4.6.4 台湾解析器分类（逐条输出）
对每个台湾解析器：
- `timeout` ⇒ **超时**
- `error` ⇒ **错误**
- `nxdomain` ⇒ **被阻断**（仅在 `baseline_ips` 非空时成立；若 baseline 空则记录为 nxdomain，但域名级异常原因为“基准无结果”）
- `ok`：
  - 命中黑名单 IP ⇒ **已封锁**
  - 否则如果 `result_ips ⊆ baseline_ips` ⇒ **正常**
  - 否则 ⇒ **解析差异**

#### 4.6.5 域名级聚合（仅输出“正常/异常”）
- 若出现任一台湾解析器为 **被阻断** ⇒ 域名级：**异常**，原因加入 **污染：被阻断**
- 若出现任一台湾解析器为 **已封锁** ⇒ 域名级：**异常**，原因加入 **污染：已封锁**
- 若出现任一台湾解析器为 **超时** ⇒ 域名级：**异常**，原因加入 **检测失败：超时**
- 若出现任一台湾解析器为 **错误** ⇒ 域名级：**异常**，原因加入 **检测失败：错误**
- 若 `baseline_ips` 为空 ⇒ 域名级：**异常**，原因加入 **基准无结果**
- 否则（无污染/封锁/检测失败）⇒ 域名级：**正常**
  - 即使台湾解析器出现 **解析差异**，域名级仍保持 **正常**，但详情会明确显示“解析差异”与 IP 差异集合

> 备注：上述聚合规则的关键点是“域名级只做可用性判断（正常/异常）”，同时把“差异”作为可解释信息保留在详情中，避免误报污染。

### 4.7 API 设计

#### 4.7.1 `GET /api/status`
- 用途：前端列表页刷新（每 10 秒轮询）
- 返回：域名摘要列表（仅正常/异常 + 时间戳）
```json
{
  "timestamp": "2025-12-31T12:00:00Z",
  "interval_sec": 10,
  "domains": [
    {"domain":"google.com","status":"正常","last_probe_at":"2025-12-31T12:00:00Z"},
    {"domain":"example.com","status":"异常","last_probe_at":"2025-12-31T12:00:00Z"}
  ]
}
```

#### 4.7.2 `GET /api/detail?domain=...`
- 用途：点击域名后展示详情
- 返回：该域名的完整探测详情（含各解析器分类、IP 列表、异常原因）
```json
{
  "domain": "google.com",
  "status": "正常",
  "reasons": [],
  "baseline": {
    "ips": ["142.250.72.14", "2404:6800:4008:c00::8a"],
    "detail": [
      {"resolver":"8.8.8.8","status":"ok","ips":["142.250.72.14"]},
      {"resolver":"1.1.1.1","status":"ok","ips":["142.250.72.14"]}
    ]
  },
  "tw": [
    {
      "resolver":"168.95.1.1",
      "category":"解析差异",
      "status":"ok",
      "ips":["203.69.113.XX"]
    },
    {
      "resolver":"101.101.101.101",
      "category":"正常",
      "status":"ok",
      "ips":["142.250.72.14"]
    }
  ],
  "last_probe_at":"2025-12-31T12:00:00Z"
}
```

#### 4.7.3 `GET /api/health`
- 用途：健康检查（Nginx upstream / 监控）
- 返回：`{"ok": true}`

---

## 5. 前端（Vue SPA）详细方案

### 5.1 技术栈
- Vue 3 + Vite
- 请求：fetch 或 axios（二选一）
- 状态管理：Pinia（可选；简单场景也可仅用组件状态）

### 5.2 标题与文案（简体中文）
- 标签页标题（`document.title`）与页面 H1 统一为：**域名台湾DNS RPZ检测**
- 所有按钮、表头、状态、提示信息均使用简体中文

### 5.3 UI 布局与响应式（中心向外延展）
**共同原则**：页面主容器居中、从中心向外延展，最大宽度限制，左右留白随视口变化而变化。

- 通用容器：
  - 内容区使用卡片/分组，保持清晰层次
- PC 端（横向布局）：
  - 域名列表（可滚动）
  - 详情面板（点击域名后以弹窗方式呈现）
- 移动端（纵向布局）：
  - 域名列表
  - 详情面板（点击域名后以弹窗方式呈现）

### 5.4 交互：从面到点
- 列表仅展示：`domain + 状态(正常/异常) + 最近检测时间`
- 点击列表项：
  - 高亮选中项
  - 弹窗展示详情，包括：
    - 域名级异常原因（若 status=异常）
    - baseline IP 集合（可折叠）
    - 各解析器：分类 + IP 列表（可折叠）
    - 便于排查的原始 `status`/`msg`（仅在错误时展示）

### 5.5 IP 列表展示（完整显示 + 可折叠）
为确保诸如 `8.8.8.8`、`google.com` 解析出多 IP 时前端仍可读：
- IP 以等宽字体展示（monospace）
- IP “标签”允许自动换行（`flex-wrap: wrap`）
- 默认仅显示前 `N=6` 个 IP，并展示“展开（共 X 条）”；展开后显示全部
- 展开/收起状态应对移动端友好（可点击区域足够大）

> 可选增强：提供“一键复制全部 IP”按钮（复制展开后的完整列表）。

### 5.6 前端定时刷新策略（每 10 秒）
- 进入页面后：立即请求一次 `/api/status`，随后 `setInterval` 每 10 秒刷新
- 若当前选中域名存在：刷新列表后同时刷新该域名详情（调用 `/api/detail`）
- 若连续多次请求失败：在页面顶部提示“API 不可用”，并保留上一次数据（避免闪烁）

---

## 6. 测试清单（上线前必须跑）
1. **Domains.txt 热更新**：修改/新增域名后，10 秒内在页面出现且有状态。
2. **多 IP 展示**：选择 `google.com` 等多 IP 域名，默认折叠，展开后完整显示且不截断。
3. **异常分支**：
   - 人为加入一个不存在域名，验证“基准无结果/被阻断”等口径展示（以规则为准）
   - 断开 53 出站或设置防火墙策略（测试环境），验证“检测失败：超时/错误”
4. **移动端布局**：缩小窗口或真机访问，布局切换为纵向，列表与详情交互可用。
5. **刷新稳定性**：连续运行 10 分钟，页面不会卡死、不会堆积请求。

---

## 7. 可选优化与需要你决策的点（不影响 MVP）
1. **“解析差异”的域名级口径**：当前定义为“仍可判正常，但详情记录差异”。如果你希望更激进（把差异视为异常），只需要调整 4.6.5 聚合规则即可。
2. **异常去抖（避免抖动）**：可增加“连续 N 次异常才标记异常”的稳定器（例如 N=2 或 N=3）。
3. **规模与性能**：当域名量级很大（>2000）时，建议引入分片探测/队列化，并把结果落盘（SQLite/Redis）。
4. **黑名单维护**：BLOCK_PAGE_IPS 需要你根据业务实际补充（支持 CIDR 会更稳）。
5. **记录类型扩展**：如需 CNAME/HTTPS/SVCB 等记录的可用性判断，可扩展 probe 逻辑与详情展示。

---

## 8. Debian VPS 部署教程（从零到上线）

以下以 Debian 12 为例，假设你有一个域名 `dns.example.com` 指向该 VPS 公网 IP。最终效果：
- Nginx 提供 HTTPS 站点
- `/` 提供前端静态站
- `/api/` 反代到本机 `127.0.0.1:8000` 的 FastAPI
- systemd 常驻后端进程
- `Domains.txt` 由你随时编辑，10 秒生效

给出详细部署教程

---

### 交付物清单（建议）
- `/opt/dnsrpz/Domains.txt`
- `backend/`（FastAPI + 定时探测）
- `frontend/`（Vue SPA + 自动刷新 + 响应式布局）
- `/etc/systemd/system/dnsrpz.service`
- `/etc/nginx/sites-available/dnsrpz.conf`
